<mat-card>
	<mat-card-header>
		<div mat-card-avatar class="example-header-image"><a mat-icon-button routerLink='/dashboard' color='warn' title='Cancel'><mat-icon>backspace</mat-icon></a></div>
		<mat-card-title>MRCTT</mat-card-title>
		<mat-card-subtitle>Mobile Randomized Controlled Trial Tool</mat-card-subtitle>
	</mat-card-header>
	<mat-card-content>
		<h1 class='mat-display-3'>{{title}}</h1>
		<form [formGroup]='newTrialForm' class='newTrialForm'>
			<mat-horizontal-stepper [linear]="isLinear" #stepper>
				<mat-step label='Basic Info'>
					<div class='mat-headline'>Registration and Trial Dates</div>
					<mat-card>
						<mat-card-content class='col'>
							<mat-form-field>
								<input
									matInput
									type='text'
									name='title'
									formControlName='title'
									placeholder='Trial Title'
									(input)='changeInput($event)' />
							</mat-form-field>
							<div class='row'>
								<mat-form-field>
									<input
										matInput
										type='text'
										name='regopen'
										formControlName='regopen'
										placeholder='Registration Opens:'
										[matDatepicker]='pickerRO'
										(input)='changeInput($event)' />
									<mat-datepicker-toggle matSuffix [for]='pickerRO'></mat-datepicker-toggle>
									<mat-datepicker #pickerRO></mat-datepicker>
								</mat-form-field>
								<mat-form-field>
									<input
										matInput
										type='text'
										name='regclose'
										formControlName='regclose'
										placeholder='Registration Closes:'
										[matDatepicker]='pickerRC'
										(input)='changeInput($event)' />
									<mat-datepicker-toggle matSuffix [for]='pickerRC'></mat-datepicker-toggle>
									<mat-datepicker #pickerRC></mat-datepicker>
								</mat-form-field>
							</div>
							<div class='row'>
								<mat-form-field>
									<input
										matInput
										type='text'
										name='trialstart'
										formControlName='trialstart'
										placeholder='Trial Starts:'
										[matDatepicker]='pickerTS'
										(input)='changeInput($event)' />
									<mat-datepicker-toggle matSuffix [for]='pickerTS'></mat-datepicker-toggle>
									<mat-datepicker #pickerTS></mat-datepicker>
								</mat-form-field>
								<mat-form-field>
									<input
										matInput
										type='text'
										name='trialend'
										formControlName='trialend'
										placeholder='Trial Ends:'
										[matDatepicker]='pickerTF'
										(input)='changeInput($event)' />
									<mat-datepicker-toggle matSuffix [for]='pickerTF'></mat-datepicker-toggle>
									<mat-datepicker #pickerTF></mat-datepicker>
								</mat-form-field>
							</div>
						</mat-card-content>
						<mat-card-actions align='end'>
							<button mat-raised-button
								matStepperNext
								color='primary'>
								Next <mat-icon>navigate_next</mat-icon>
							</button>
						</mat-card-actions>
					</mat-card>
				</mat-step>
				<mat-step label='Groups'>
					<div class='mat-headline'>Trial Groups</div>
					<mat-card>
						<mat-card-content>
							<mat-form-field>
								<input
									matInput
									type='number'
									name='ngroups'
									min=1
									value=1
									placeholder='Number of Groups:'
									(input)='changeInput($event)' />
							</mat-form-field>
							<mat-divider></mat-divider>
							<div formArrayName="groups"
								*ngFor="let group of groups.controls; index as i">
								<div [formGroupName]='i' class='col'>
									<div class='row'>
										<mat-form-field>
											<input
												matInput
												tabindex='0'
												type='text'
												name='group_name'
												formControlName='group_name'
												placeholder='Group Name:'
												autocomplete='off'
												(input)='changeInput($event)'/>
										</mat-form-field>
									</div>
									<mat-divider *ngIf='i < groups.value.length-1'></mat-divider>
								</div>
							</div>
						</mat-card-content>
						<mat-card-actions align='end'>
							<button mat-button
								matStepperPrevious
								(click)='togglePrevCard()'>
								<mat-icon>navigate_before</mat-icon> Previous
							</button>
							<button mat-raised-button
								matStepperNext
								color='primary'>
								Next <mat-icon>navigate_next</mat-icon>
							</button>
						</mat-card-actions>
					</mat-card>
				</mat-step>
				<mat-step label='Surveys'>
					<div class='mat-headline'>Survey Settings and Questions</div>
					<mat-accordion>
						<mat-expansion-panel
							formArrayName='surveys'
							*ngFor='let survey of surveys.controls; index as s'
							(opened)="setEditingSurvey(s)">
							<mat-expansion-panel-header>
								<mat-panel-title>
									<mat-icon *ngIf="!survey.get('survey_name').value">add_circle</mat-icon>
									<div class='survey'>{{ survey.get('survey_name').value || 'add new survey' }}</div>
								</mat-panel-title>
								<mat-panel-description>
									{{ (survey.get('survey_questions').value.length > 1) ? (survey.get("survey_questions").value.length-1) + " question"+(survey.get("survey_questions").value.length>2?"s":"") : "" }}
								</mat-panel-description>
							</mat-expansion-panel-header>
							<ng-template matExpansionPanelContent>
								<div [formGroupName]='s' class='col'>
									<mat-form-field>
										<input
											matInput
											type='text'
											placeholder='Survey Name:'
											name='survey_name'
											formControlName='survey_name'
											(input)='changeInput($event)'/>
									</mat-form-field>
									<div *ngIf='survey.get("survey_name").value.length > 0'>
										<div class='mat-subheading-2'>Request survey from the following Groups:</div>
										<div class='item_group_cell'
											*ngFor='let group of groups.controls; index as t'>
											<mat-checkbox
												type='checkbox'
												name='survey_groups'
												(input)='changeGroupAssignment($event, survey.controls["survey_groups"], group.controls["group_id"].value )'>
												{{ group.controls['group_name'].value || 'Group '+(group.controls['group_id'].value+1) }}
											</mat-checkbox>
										</div>
										<div class='mat-subheading-2'>Request survey at these intervals:</div>
										<div class='row'>
											<div class='col'>
												<mat-checkbox
													type='checkbox'
													name='survey_pre'
													formControlName='survey_pre'
												>Pretest</mat-checkbox>
												<mat-checkbox
													type='checkbox'
													name='survey_during'
													formControlName='survey_during'
												>During Treatment</mat-checkbox>
												<mat-checkbox
													type='checkbox'
													name='survey_post'
													formControlName='survey_post'
												>Posttest</mat-checkbox>
											</div>
											<div class='col surveyFrequency'
												*ngIf='survey.controls["survey_during"].value'>
												<mat-form-field>
													<input
														matInput
														type='number'
														name='survey_interval'
														formControlName='survey_interval'
														placeholder='{{ "Allow new submission every " + survey.controls["survey_interval"].value + " " + survey.controls["survey_frequency"].value  }}'/>
												</mat-form-field>
											</div>
										</div>
									</div>
								</div>
								<mat-divider *ngIf='survey.get("survey_name").value.length > 0'></mat-divider>
								<div [formGroupName]='s' class='questions'
									*ngIf='survey.get("survey_name").value.length > 0'>
									<div class='mat-h2'>Questions:</div>
									<div formArrayName='survey_questions'
										*ngFor='let question of survey.controls["survey_questions"].controls; index as q'
										class='col'>
										<div [formGroupName]='q' class='row'>
											<h3 class='mat-h3 formFieldLabel'>â„–{{q+1}}:</h3>
											<mat-form-field class='fullFlex'>
												<input
													matInput
													type='text'
													placeholder='Question Text:'
													name='question_text'
													formControlName='question_text'
													(input)='changeInput($event)'/>
											</mat-form-field>
											<mat-form-field class='fullFlex'>
												<mat-select
													name='question_type'
													placeholder='Question Type:'
													formControlName='question_type'>
													<mat-option value='text'>Text</mat-option>
													<mat-option value='mc'>Multiple Choice</mat-option>
												</mat-select>
											</mat-form-field>
										</div>
										<div [formGroupName]='q' class='row'
										*ngIf='question.get("question_type").value !== "text"'>
											<mat-form-field class='fullFlex h3Indent'>
												<input
													matInput
													type='text'
													placeholder='Enter Multiple Choice Options:'
													name='question_options'
													formControlName='question_options'/>
												<mat-hint align='start'>Delimit the options with the pipe symbol (|)</mat-hint>
			    								<mat-hint align='end'></mat-hint>
											</mat-form-field>
										</div>
										<mat-divider *ngIf='survey.controls["survey_questions"].controls.length-1 !== q'></mat-divider>
									</div>
								</div>
							</ng-template>
							<mat-action-row>
								<button mat-stroked-button color='warn' disabled>
									<mat-icon>delete_forever</mat-icon> Delete
								</button>
							</mat-action-row>
						</mat-expansion-panel>
					</mat-accordion>
					<mat-action-row align='end'>
						<button mat-button
							matStepperPrevious>
							<mat-icon>navigate_before</mat-icon> Previous
						</button>
						<button mat-raised-button
							matStepperNext
							color='primary'>
							Next <mat-icon>navigate_next</mat-icon>
						</button>
					</mat-action-row>
				</mat-step>
				<!-- Confirmation Summary -->
				<mat-step label='Done'>
					<div class='mat-headline'>Confirm</div>
					<mat-card>
						<mat-card-title>
						</mat-card-title>
						<mat-card-content>
							<div class='col'>
								<h2 class='mat-h2'>{{ newTrialForm.get('title').value || "N/A" }}</h2>
								<div class='col section'>
									<h3 class='mat-h3'>Registration</h3>
									<span> from: </span>
									<span class='mono'>{{ newTrialForm.get('regopen').value || "N/A" }}</span>
									<span> to </span>
									<span class='mono'>{{ newTrialForm.get('regclose').value || "N/A" }}</span>
								</div>
								<div class='col section'>
									<h3 class='mat-h3'>Trial</h3>
									<span> from: </span>
									<span class='mono'>{{ newTrialForm.get('trialstart').value || "N/A" }}</span>
									<span> to </span>
									<span class='mono'>{{ newTrialForm.get('trialend').value || "N/A" }}</span>
								</div>
								<div class='col section'>
									<h3 class='mat-h3'>Groups</h3>
									<div class='row'>
										<span>Number of Groups:</span>
										<span class='mono'>{{ newTrialForm.get('groups').controls.length || "N/A" }}</span>
									</div>
									<div class='col'
									*ngFor='let group of newTrialForm.get("groups").controls; index as g'>
										<div class='row'>
											<span>Group {{ g+1 }}:</span>
											<span class='mono'>{{ group.get('group_name').value || "N/A" }}</span>
											<span>; Sizing:</span>
											<span class='mono'>{{ group.get('group_size').value }}</span>
											<span *ngIf='group.get("group_size").value !== "auto"'
											> - {{ group.get('group_size_n').value }}</span>
										</div>
									</div>
								</div>
								<div class='col section'>
									<h3 class='mat-h3'>Surveys</h3>
									<div class='col subsection'
									*ngFor='let survey of newTrialForm.get("surveys").controls; index as s'>
										<div class='col'
										*ngIf='s < newTrialForm.get("surveys").controls.length-1'>
											<h5 class='mono'>{{ survey.get('survey_name').value || "N/A" }}</h5>
											<div class='row'>
												<span>Applies to Groups:</span>
												<div class='row'
												 *ngFor='let group of survey.get("survey_groups").value; index as g'>
													<span class='mono'>
														{{ newTrialForm.get('groups').controls[group].get('group_name').value || "N/A" }}
													</span>
													<span *ngIf='g < survey.get("survey_groups").value.length-1'>,</span>
												</div>
											</div>
											<div class='col'>
												<span>Questions:</span>
												<div
												*ngFor='let question of survey.get("survey_questions").controls; index as q'>
													<span class='mono'
													*ngIf='q < survey.get("survey_questions").controls.length-1'>
														{{ q+1 }}: {{ question.get('question_text').value }}
													</span>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
						</mat-card-content>
						<mat-card-actions align='end'>
							<button mat-raised-button
							color='accent'
							(click)='newTrial($event)'>
								New Trial
							</button>
						</mat-card-actions>
					</mat-card>
				</mat-step>
			</mat-horizontal-stepper>
		</form>
	</mat-card-content>
</mat-card>
